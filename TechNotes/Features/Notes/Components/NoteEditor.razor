@page "/note-editor"
@page "/note-editor/{NoteId:int}"
@using TechNotes.Shared


@inject ISender Sender
@inject NavigationManager NavigationManager


@if( isEditMode && Note is not null )
{
  <PageTitle>Editar nota</PageTitle>
  <h3>Editar nota - @Note.Title</h3>
  <a href="notes" class="btn-secondary mb-2">Volver a las notas</a>
}
else
{
  <PageTitle>Crear nota</PageTitle>
  <h3>Crear nota</h3>
}

@if(Note is not null)
{
  <EditForm Model="Note" OnSubmit="HandleSubmit" FormName="NoteEditorForm">
    <InputText @bind-Value="Note.Title" placeholder="Título" class="form-control mb-2" />
    <InputTextArea @bind-Value="Note.Content" placeholder="Nota" class="form-control mb-2" rows="5" />
    <label>Fecha de publicación</label>
    <InputDate @bind-Value="Note.PublishedAt" class="form-control mb-2"/>
    <label class="form-check-label mb-2">Publicado:</label>
    <InputCheckbox @bind-Value="Note.IsPublished" class="form-check-input mb-2" />

    <button class="@(isEditMode ? " btn-primary" : "btn-success") btn mt-3 w-100" type="submit">@(isEditMode ? "Editar" : "Crear")</button>
  </EditForm>
  @if(isEditMode){
    <form @onsubmit="DeleteNote" @formname="DeleteNoteForm" method="POST">
      <button type="submit" class="btn btn-danger mt-2">Eliminar nota</button>
      <AntiforgeryToken />
    </form>
  }
}


<a href="/notes" class="btn btn-outline-primary mt-3">Volver</a>

<span class="text-danger">@errorMessage</span>

@code {
    private bool isEditMode => NoteId != null;
    private string errorMessage = string.Empty;

    [SupplyParameterFromForm]
    private NoteModel? Note {get; set;}

    [Parameter]
    public int? NoteId {set; get;}

    protected override async Task OnParametersSetAsync()
    {
        if(NoteId is not null)
        {
          var result = await Sender.Send(new GetNoteByIdQuery {Id = (int)NoteId});
          if(result.IsSuccessful)
          {
            // ??= es null-coalesing, si Note es null entonces lo igualamos al result.Adapt, sino se mantiene el Note original.
            Note ??= result.Value.Adapt<NoteModel>();  
              Note.Id = (int)NoteId;
          }
          else
          {
            SetErrorMessage(result.ErrorMessage);
          }
          
        }
        else
          {
            Note ??= new();
          }
    }

    private async Task HandleSubmit()
    { 
      if(isEditMode){
        var command = Note.Adapt<UpdateNoteCommand>();
        var result = await Sender.Send(command);

        if(result.IsSuccessful) 
        {
          Note = result.Value.Adapt<NoteModel>();
          Console.WriteLine("Nota actualizada exitosamente!");
        }
        else
        {
          SetErrorMessage(result.ErrorMessage);
        }
        
      }
      else
      {
        var command = Note.Adapt<CreateNoteCommand>();
        var result = await Sender.Send(command);

        if(result.IsSuccessful)
        {
          Note = result.Adapt<NoteModel>();
          Console.WriteLine("Nota creada exitosamente!");
        }
        else
        {
          SetErrorMessage(result.ErrorMessage);
        }

      }
      
        NavigationManager.NavigateTo("/notes");
    }

    private async Task DeleteNote()
    {
      if(NoteId is null) return;

      var command = new DeleteNoteCommand { Id = (int)NoteId };

      var result = await Sender.Send(command);

      if(result.IsSuccessful)
      {
        Console.WriteLine("Nota eliminada exitosamente!");
        NavigationManager.NavigateTo("/notes");
      }else
      {
        Console.WriteLine("Error al eliminar la nota!");
      }
    }


    private void SetErrorMessage(string? error)
    {
      errorMessage = error ?? string.Empty;
    }
}
